- name: Convert test-result-codecoverage.json to CoverageReport.csv
  run: |
    echo "Converting test-result-codecoverage.json to CoverageReport.csv..."
    FILE_PATH="force-app/main/default/lwc/tmpLwcComponent/test/test-result-codecoverage.json"
    CSV_PATH="force-app/main/default/lwc/tmpLwcComponent/test/CoverageReport.csv"

    if [ ! -f "$FILE_PATH" ]; then
      echo "❌ File not found: $FILE_PATH"
      exit 1
    fi

    # Add headers
    echo "Id,Name,TotalLines,CoveredLines,TotalCovered,CoveredPercent" > "$CSV_PATH"

    # Convert JSON to CSV
    jq -r '
      .[] |
      [
        .id,
        .name,
        .totalLines,
        (.lines | keys_unsorted | join(";")),
        .totalCovered,
        .coveredPercent
      ] | @csv
    ' "$FILE_PATH" >> "$CSV_PATH"

    echo "✅ CoverageReport.csv generated:"
    cat "$CSV_PATH"
