@IsTest
private class WeeklyVulnerabilityEmailServiceTest {

    // Creates one vulnerability record that matches the query filters
    private static Vulnerability__c createTestVulnerability(Integer severity) {
        Vulnerability__c v = new Vulnerability__c(
            Severity__c = severity,       // Number field
            Status__c   = 'Open',         // Must match your picklist/text value
            Rule__c     = 'ApexRule1',
            File__c     = 'classes/TestClass.cls',
            Line__c     = 42
        );
        insert v;
        return v;
    }

    @IsTest
    static void testSendWeeklyEmail_WithData() {
        // Arrange: record that matches LAST_N_DAYS:7 + filters
        createTestVulnerability(5); // e.g. severity 5 = Critical

        Test.startTest();
        WeeklyVulnerabilityEmailService.sendWeeklyEmail();
        Test.stopTest();

        // Assert: exactly one email was sent
        Integer invocations = Limits.getEmailInvocations();
        System.assertEquals(1, invocations,
            'One email should be sent when there is data');
    }

    @IsTest
    static void testSendWeeklyEmail_NoData() {
        // No Vulnerability__c records created -> query should be empty

        Test.startTest();
        WeeklyVulnerabilityEmailService.sendWeeklyEmail();
        Test.stopTest();

        // Assert: no email should be sent
        Integer invocations = Limits.getEmailInvocations();
        System.assertEquals(0, invocations,
            'No email should be sent when there is no data');
    }

    @IsTest
    static void testExecuteSchedulable_NoData() {
        // Covers the execute(SchedulableContext) entrypoint
        WeeklyVulnerabilityEmailService svc = new WeeklyVulnerabilityEmailService();

        Test.startTest();
        svc.execute(null); // context not used in implementation
        Test.stopTest();

        Integer invocations = Limits.getEmailInvocations();
        System.assertEquals(0, invocations,
            'No email should be sent from execute() when there is no data');
    }

    @IsTest
    static void testHelperMethods() {
        // Arrange: record with characters that exercise HTML & CSV escaping
        Vulnerability__c v = new Vulnerability__c(
            Severity__c = 3,
            Status__c   = 'Open',
            Rule__c     = 'Rule,With,"Quotes"',
            File__c     = 'classes/Test<Class>.cls',
            Line__c     = 99
        );
        insert v;

        // Query fields used by the main class
        List<Vulnerability__c> vulns = [
            SELECT Id,
                   Severity__c,
                   Status__c,
                   Rule__c,
                   File__c,
                   Line__c,
                   CreatedDate
            FROM Vulnerability__c
        ];

        Test.startTest();
        String html =
            WeeklyVulnerabilityEmailService.buildHtmlBody(vulns);
        String csv  =
            WeeklyVulnerabilityEmailService.buildCsv(vulns);
        String escapedHtml =
            WeeklyVulnerabilityEmailService.escapeHtml('<test>');
        String escapedCsv  =
            WeeklyVulnerabilityEmailService.csvEscape('val,"with",comma');
        Test.stopTest();

        // HTML assertions
        System.assert(
            html.contains('Weekly Code Vulnerability Report'),
            'HTML body should contain the report header'
        );
        System.assert(
            html.contains('&lt;test&gt;'),
            'escapeHtml should escape < and >'
        );

        // CSV assertions
        System.assert(
            csv.startsWith('Name,Severity,Status,Rule,File,Line,CreatedDate'),
            'CSV should start with the header row'
        );
        System.assert(
            csv.contains('classes/Test<Class>.cls'),
            'CSV should include the file path'
        );

        // csvEscape assertions
        System.assert(
            escapedCsv.startsWith('"') && escapedCsv.endsWith('"'),
            'csvEscape should wrap fields with commas/quotes in double quotes'
        );
        System.assert(
            escapedCsv.contains('""with""'),
            'csvEscape should double internal quotes'
        );
    }
}
