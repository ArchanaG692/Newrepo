@IsTest
private class WeeklyVulnerabilityEmailServiceTest {

    // Creates one vulnerability record that matches the query filters
    private static Vulnerability__c createTestVulnerability(
        String name,
        String severity
    ) {
        Vulnerability__c v = new Vulnerability__c(
            Name        = name,
            Severity__c = severity,     // must match your picklist values
            Status__c   = 'Open',       // must match your picklist values
            RuleName__c = 'ApexRule1',
            FilePath__c = 'classes/TestClass.cls',
            LineNumber__c = 42
        );
        insert v;
        return v;
    }

    @IsTest
    static void testSendWeeklyEmail_WithData() {
        // Arrange: create data that will be picked up by LAST_N_DAYS:7 query
        Vulnerability__c v = createTestVulnerability('Test Vuln Critical', 'Critical');

        Test.startTest();
        WeeklyVulnerabilityEmailService.sendWeeklyEmail();
        Test.stopTest();
        
        // Assert: one email sent
        Messaging.SingleEmailMessage[] emails = System.Test.getSentEmailMessages();
        
        System.assertEquals(1, emails.size(), 'One email should be sent when there is data');
        
        Messaging.SingleEmailMessage email = emails[0];

        // Subject check
        System.assert(
            email.getSubject().contains('Weekly Code Vulnerability Report'),
            'Subject should contain weekly report text'
        );

        // Attachment check
        Messaging.EmailFileAttachment[] atts = email.getFileAttachments();
        System.assertEquals(1, atts.size(), 'One CSV attachment expected');

        Messaging.EmailFileAttachment att = atts[0];
        System.assert(
            att.getFileName().startsWith('Weekly_Vulnerabilities_'),
            'CSV filename should start with Weekly_Vulnerabilities_'
        );
        System.assertNotEquals(null, att.getBody(), 'Attachment body must not be null');

        String csv = att.getBody().toString();

        // Basic checks on CSV content
        System.assert(
            csv.startsWith('Name,Severity,Status,Rule,File,Line,CreatedDate'),
            'CSV should start with header'
        );
        System.assert(
            csv.contains('Test Vuln Critical'),
            'CSV should contain the test vulnerability row'
        );
    }

    @IsTest
    static void testSendWeeklyEmail_NoData() {
        // No data created that matches filters

        Test.startTest();
        WeeklyVulnerabilityEmailService.sendWeeklyEmail();
        Test.stopTest();

        // Assert: no emails should be sent
        List<Messaging.SingleEmailMessage> emails = Test.getSentEmailMessages();
        System.assertEquals(0, emails.size(), 'No email should be sent when there is no data');
    }

    @IsTest
    static void testExecuteSchedulable_NoData() {
        // Directly call execute to cover the Schedulable entry point
        WeeklyVulnerabilityEmailService svc = new WeeklyVulnerabilityEmailService();

        Test.startTest();
        // Passing null is okay because execute() doesnâ€™t use the context
        svc.execute(null);
        Test.stopTest();

        // With no data, no emails should be sent
        List<Messaging.SingleEmailMessage> emails = Test.getSentEmailMessages();
        System.assertEquals(0, emails.size(), 'No email expected from execute() when no data');
    }

    @IsTest
    static void testHelperMethods() {
        // Arrange: create one record with some special chars to test escaping
        Vulnerability__c v = new Vulnerability__c(
            Name        = 'Html <Test> "Vuln"',
            Severity__c = 'High',
            Status__c   = 'Open',
            RuleName__c = 'Rule,With,Comma',
            FilePath__c = 'classes/TestClass.cls',
            LineNumber__c = 99
        );
        insert v;

        // Query using same fields as the main class
        List<Vulnerability__c> vulns = [
            SELECT Id, Name, Severity__c, Status__c, RuleName__c,
                   FilePath__c, LineNumber__c, CreatedDate
            FROM Vulnerability__c
        ];

        Test.startTest();
        String html = WeeklyVulnerabilityEmailService.buildHtmlBody(vulns);
        String csv  = WeeklyVulnerabilityEmailService.buildCsv(vulns);
        String escapedHtml = WeeklyVulnerabilityEmailService.escapeHtml('<test>');
        String escapedCsv  = WeeklyVulnerabilityEmailService.csvEscape('val,"with",comma');
        Test.stopTest();

        // HTML assertions
        System.assert(
            html.contains('Weekly Code Vulnerability Report'),
            'HTML body should contain header text'
        );
        System.assert(
            html.contains('&lt;Test&gt;'),
            'HTML body should contain escaped version of <Test>'
        );

        // CSV assertions
        System.assert(
            csv.contains('Name,Severity,Status,Rule,File,Line,CreatedDate'),
            'CSV should include header row'
        );
        System.assert(
            csv.contains('Html <Test> "Vuln"'),
            'CSV should include vulnerability name'
        );

        // escapeHtml assertions
        System.assertEquals(
            '&lt;test&gt;',
            escapedHtml,
            'escapeHtml should escape < and >'
        );

        // csvEscape should quote and escape internal quotes
        System.assert(
            escapedCsv.startsWith('"') && escapedCsv.endsWith('"'),
            'csvEscape should wrap field in quotes when needed'
        );
        System.assert(
            escapedCsv.contains('""with""'),
            'csvEscape should double internal quotes'
        );
    }
}
