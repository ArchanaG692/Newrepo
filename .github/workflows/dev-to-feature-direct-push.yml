name: dev-to-feature-direct-push

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches:
      - "feature/**"   # PR base must be feature/*

permissions:
  contents: write
  pull-requests: write

jobs:
  cherry_pick_and_push_to_feature:
    # Only when PR is from dev -> feature/*
    if: startsWith(github.base_ref, 'feature/') && github.head_ref == 'dev'
    runs-on: ubuntu-latest

    steps:
      - name: Parse commit list from PR body
        env:
          BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail
          echo "----- PR BODY START -----"
          echo "$BODY"
          echo "----- PR BODY END -----"

          COMMITS=$(python3 -c '
          import os, re
          body = (os.environ.get("BODY") or "").replace("\r\n","\n")
          lines = body.splitlines()
          
          key_re = re.compile(r"^\s*CHERRY[\s_]+PICK[\s_]+COMMITS\s*:\s*(.*)$", re.IGNORECASE)
          sha_re = re.compile(r"\b[0-9a-f]{7,40}\b")
          
          commits=[]
          for i,l in enumerate(lines):
              m=key_re.match(l)
              if not m:
                  continue
              commits += sha_re.findall(m.group(1) or "")
              j=i+1
              while j < len(lines) and lines[j].strip():
                  commits += sha_re.findall(lines[j])
                  j += 1
              break
          
          print(" ".join(commits))
          ')
          if [ -z "$COMMITS" ]; then
            echo "ERROR: No commits found. Add in PR body:"
            echo "CHERRY PICK COMMITS:"
            echo "7233de3"
            exit 1
          fi

          echo "COMMITS=$COMMITS" >> $GITHUB_ENV
          echo "Selected commits: $COMMITS"

      - name: Checkout feature branch (target)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all refs
        run: |
          git fetch origin --prune --no-tags \
            +refs/heads/*:refs/remotes/origin/* \
            +refs/pull/*/head:refs/remotes/origin/pull/*

      - name: Cherry-pick selected commits onto feature (SOURCE wins on conflict)
        run: |
          set -euo pipefail

          resolve_conflicts_source_wins () {
            local sha="$1"
            echo "Conflict detected. Using SOURCE (commit $sha) for conflicted files..."

            local conflict_files
            conflict_files=$(git diff --name-only --diff-filter=U || true)

            if [ -z "$conflict_files" ]; then
              echo "No conflicted files detected (unexpected)."
              return 0
            fi

            mkdir -p /tmp/srcfiles

            for f in $conflict_files; do
              echo "Resolving conflicted file (SOURCE wins): $f"
              if ! git show "$sha:$f" > "/tmp/srcfiles/$(basename "$f")" 2>/dev/null; then
                echo "WARN: $f not found in commit $sha. Leaving as-is."
                continue
              fi
              cp "/tmp/srcfiles/$(basename "$f")" "$f"
            done

            git add $conflict_files

            if git diff --name-only --diff-filter=U | grep -q .; then
              echo "ERROR: Conflicts remain after SOURCE-wins resolution:"
              git diff --name-only --diff-filter=U
              exit 1
            fi

            if git diff --cached --quiet; then
              echo "Cherry-pick became empty after resolution -> skipping $sha"
              git cherry-pick --skip
            else
              git cherry-pick --continue
            fi
          }

          for sha in $COMMITS; do
            echo "===== Processing commit: $sha ====="
            if git cherry-pick "$sha"; then
              echo "Cherry-pick succeeded: $sha"
            else
              resolve_conflicts_source_wins "$sha"
            fi
          done

      - name: Push changes directly to feature branch
        run: |
          set -euo pipefail
          git push origin "HEAD:${{ github.base_ref }}"

      - name: Comment on PR #1
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request.number;
            const base = context.payload.pull_request.base.ref;
            const commits = (process.env.COMMITS || "").split(" ").filter(Boolean);

            await github.rest.issues.createComment({
              owner, repo, issue_number: pr,
              body: [
                `✅ Cherry-pick completed and pushed directly to \`${base}\`.`,
                ``,
                `Commits applied:`,
                ...commits.map(c => `- \`${c}\``),
                ``,
                `Next: raise a PR from \`${base}\` ➜ \`INT1\` to trigger code scan + merge gate.`
              ].join("\n")
            });
