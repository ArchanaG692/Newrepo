name: dev-to-feature-direct-push

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches:
      - "feature/**"   # PR base must be feature/*

permissions:
  contents: write
  pull-requests: write


jobs:
  cherry_pick_and_push_to_feature:
    if: startsWith(github.event.pull_request.base.ref, 'feature-') && github.event.pull_request.head.ref == 'Dev1'
    runs-on: ubuntu-latest

    steps:
      - name: Parse commit list from PR body
        env:
          BODY: ${{ github.event.pull_request.body }}
        run: |
          set -euo pipefail
          echo "----- PR BODY START -----"
          echo "$BODY"
          echo "----- PR BODY END -----"

          COMMITS=$(python3 -c '
          import os, re
          body = (os.environ.get("BODY") or "").replace("\r\n","\n")
          lines = body.splitlines()
          
          key_re = re.compile(r"^\s*CHERRY[\s_]+PICK[\s_]+COMMITS\s*:\s*(.*)$", re.IGNORECASE)
          sha_re = re.compile(r"\b[0-9a-f]{7,40}\b")
          
          commits=[]
          for i,l in enumerate(lines):
              m=key_re.match(l)
              if not m:
                  continue
              commits += sha_re.findall(m.group(1) or "")
              j=i+1
              while j < len(lines) and lines[j].strip():
                  commits += sha_re.findall(lines[j])
                  j += 1
              break
          
          print(" ".join(commits))
          ')
          if [ -z "$COMMITS" ]; then
            echo "ERROR: No commits found. Add in PR body:"
            echo "CHERRY PICK COMMITS:"
            echo "7233de3"
            exit 1
          fi

          echo "COMMITS=$COMMITS" >> $GITHUB_ENV
          echo "Selected commits: $COMMITS"

      - name: Checkout feature branch (target)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all refs
        run: |
          git fetch origin --prune --no-tags \
            +refs/heads/*:refs/remotes/origin/* \
            +refs/pull/*/head:refs/remotes/origin/pull/*

      - name: Cherry-pick selected commits onto feature (SOURCE wins on conflict)
        run: |
          set -euo pipefail

          resolve_conflicts_source_wins () {
            local sha="$1"
            echo "Conflict detected. Using SOURCE (commit $sha) for conflicted files..."

            local conflict_files
            conflict_files=$(git diff --name-only --diff-filter=U || true)

            if [ -z "$conflict_files" ]; then
              echo "No conflicted files detected (unexpected)."
              return 0
            fi

            mkdir -p /tmp/srcfiles

            for f in $conflict_files; do
              echo "Resolving conflicted file (SOURCE wins): $f"
              if ! git show "$sha:$f" > "/tmp/srcfiles/$(basename "$f")" 2>/dev/null; then
                echo "WARN: $f not found in commit $sha. Leaving as-is."
                continue
              fi
              cp "/tmp/srcfiles/$(basename "$f")" "$f"
            done

            git add $conflict_files

            if git diff --name-only --diff-filter=U | grep -q .; then
              echo "ERROR: Conflicts remain after SOURCE-wins resolution:"
              git diff --name-only --diff-filter=U
              exit 1
            fi

            if git diff --cached --quiet; then
              echo "Cherry-pick became empty after resolution -> skipping $sha"
              git cherry-pick --skip
            else
              git cherry-pick --continue
            fi
          }

          for sha in $COMMITS; do
            echo "===== Processing commit: $sha ====="
            if git cherry-pick "$sha"; then
              echo "Cherry-pick succeeded: $sha"
            else
              resolve_conflicts_source_wins "$sha"
            fi
          done

      - name: Push changes directly to feature branch
        run: |
          set -euo pipefail
          git push origin "HEAD:${{ github.base_ref }}"

      # ---- NEW: Deliverable / proof (optional but useful) ----
      - name: Generate delivery summary (what was applied)
        run: |
          set -euo pipefail
          git fetch origin --prune --no-tags +refs/heads/*:refs/remotes/origin/*

          BASELINE="origin/INT1"
          FEATURE="HEAD"

          echo "=== Commits on feature vs INT1 ===" | tee delivery_summary.md
          git log --oneline "${BASELINE}..${FEATURE}" | tee -a delivery_summary.md || true

          echo "" | tee -a delivery_summary.md
          echo "=== Files changed (name-status) ===" | tee -a delivery_summary.md
          git diff --name-status "${BASELINE}..${FEATURE}" | tee -a delivery_summary.md || true

          echo "" | tee -a delivery_summary.md
          echo "=== Diff stats ===" | tee -a delivery_summary.md
          git diff --stat "${BASELINE}..${FEATURE}" | tee -a delivery_summary.md || true

          git diff "${BASELINE}..${FEATURE}" > cherry-pick.patch || true

      - name: Upload delivery artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cherry-pick-delivery
          path: |
            delivery_summary.md
            cherry-pick.patch

      - name: Comment on PR #1 with delivery proof
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request.number;
            const base = context.payload.pull_request.base.ref; // feature/*
            const commits = (process.env.COMMITS || "").split(" ").filter(Boolean);

            const compareUrl = `https://github.com/${owner}/${repo}/compare/INT1...${encodeURIComponent(base)}`;

            await github.rest.issues.createComment({
              owner, repo, issue_number: pr,
              body: [
                `✅ Cherry-pick completed and pushed directly to \`${base}\`.`,
                ``,
                `**Commits requested:**`,
                ...commits.map(c => `- \`${c}\``),
                ``,
                `**Delivery / proof:**`,
                `- Compare (INT1 → ${base}): ${compareUrl}`,
                `- Artifact in this workflow run: **cherry-pick-delivery** (delivery_summary.md + cherry-pick.patch)`,
                ``,
                `**Next:** Raise PR from \`${base}\` ➜ \`INT1\` to trigger code scan + merge gate.`
              ].join("\n")
            });

      # ---- NEW: Label PR as automation + close it automatically ----
      - name: Label and close PR #1 (automation request)
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request.number;

            // Ensure these labels exist in the repo:
            // - cherry-pick-request
            // - automation
            // - cherry-pick-applied
            const labelsToAdd = ["cherry-pick-request", "automation", "cherry-pick-applied"];

            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr,
                labels: labelsToAdd
              });
            } catch (e) {
              core.info("Could not add one or more labels (create them in repo Settings → Labels).");
            }

            // Close PR #1 so it doesn't look like a normal PR waiting for merge
            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: pr,
              state: "closed"
            });
